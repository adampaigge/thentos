<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Servant.Server.Internal.RoutingApplication</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Servant-Server-Internal-RoutingApplication.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">servant-server-0.5: A family of combinators for defining webservices APIs and serving them</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Servant.Server.Internal.RoutingApplication</p></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><span class="keyword">type</span> <a href="#t:RoutingApplication">RoutingApplication</a> = Request -&gt; (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> Response -&gt; <a href=""/>IO</a> ResponseReceived) -&gt; <a href=""/>IO</a> ResponseReceived</li><li class="src short"><span class="keyword">data</span> <a href="#t:RouteResult">RouteResult</a> a<ul class="subs"><li>= <a href="#v:Fail">Fail</a> <a href="Servant-Server-Internal-ServantErr.html#t:ServantErr">ServantErr</a></li><li>| <a href="#v:FailFatal">FailFatal</a> !<a href="Servant-Server-Internal-ServantErr.html#t:ServantErr">ServantErr</a></li><li>| <a href="#v:Route">Route</a> !a</li></ul></li><li class="src short"><span class="keyword">data</span> <a href="#t:ReqBodyState">ReqBodyState</a><ul class="subs"><li>= <a href="#v:Uncalled">Uncalled</a></li><li>| <a href="#v:Called">Called</a> !<a href=""/>ByteString</a></li><li>| <a href="#v:Done">Done</a> !<a href=""/>ByteString</a></li></ul></li><li class="src short"><a href="#v:toApplication">toApplication</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:RoutingApplication">RoutingApplication</a> -&gt; Application</li><li class="src short"><span class="keyword">data</span> <a href="#t:Delayed">Delayed</a> :: * -&gt; * <span class="keyword">where</span><ul class="subs"><li><a href="#v:Delayed">Delayed</a> ::  <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> ()) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> b) -&gt; (a -&gt; b -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> c) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> c</li></ul></li><li class="src short"><a href="#v:addCapture">addCapture</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> (a -&gt; b) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> b</li><li class="src short"><a href="#v:addMethodCheck">addMethodCheck</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> ()) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a</li><li class="src short"><a href="#v:addBodyCheck">addBodyCheck</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> (a -&gt; b) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> b</li><li class="src short"><a href="#v:addAcceptCheck">addAcceptCheck</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> ()) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a</li><li class="src short"><a href="#v:passToServer">passToServer</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> (a -&gt; b) -&gt; a -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> b</li><li class="src short"><a href="#v:bindRouteResults">bindRouteResults</a> :: <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; (a -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> b)) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> b)</li><li class="src short"><a href="#v:combineRouteResults">combineRouteResults</a> :: (a -&gt; b -&gt; c) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> b) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> c)</li><li class="src short"><a href="#v:runDelayed">runDelayed</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a)</li><li class="src short"><a href="#v:runAction">runAction</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> (<a href=""/>ExceptT</a> <a href="Servant-Server-Internal-ServantErr.html#t:ServantErr">ServantErr</a> <a href=""/>IO</a> a) -&gt; (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> Response -&gt; <a href=""/>IO</a> r) -&gt; (a -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> Response) -&gt; <a href=""/>IO</a> r</li></ul></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><span class="keyword">type</span> <a name="t:RoutingApplication" class="def">RoutingApplication</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">&nbsp;= Request</td><td class="doc"><p>the request, the field <code>pathInfo</code> may be modified by url routing</p></td></tr><tr><td class="src">-&gt; (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> Response -&gt; <a href=""/>IO</a> ResponseReceived)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href=""/>IO</a> ResponseReceived</td><td class="doc empty">&nbsp;</td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a name="t:RouteResult" class="def">RouteResult</a> a</p><div class="doc"><p>The result of matching against a path in the route tree.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Fail" class="def">Fail</a> <a href="Servant-Server-Internal-ServantErr.html#t:ServantErr">ServantErr</a></td><td class="doc"><p>Keep trying other paths. The <code>ServantErr</code>
 should only be 404, 405 or 406.</p></td></tr><tr><td class="src"><a name="v:FailFatal" class="def">FailFatal</a> !<a href="Servant-Server-Internal-ServantErr.html#t:ServantErr">ServantErr</a></td><td class="doc"><p>Don't try other paths.</p></td></tr><tr><td class="src"><a name="v:Route" class="def">Route</a> !a</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="subs instances"><p id="control.i:RouteResult" class="caption collapser" onclick="toggleSection('i:RouteResult')">Instances</p><div id="section.i:RouteResult" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><a href=""/>Functor</a> <a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a></span></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href=""/>Eq</a> a =&gt; <a href=""/>Eq</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a)</span></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href=""/>Read</a> a =&gt; <a href=""/>Read</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a)</span></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src clearfix"><span class="inst-left"><a href=""/>Show</a> a =&gt; <a href=""/>Show</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a)</span></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a name="t:ReqBodyState" class="def">ReqBodyState</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Uncalled" class="def">Uncalled</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Called" class="def">Called</a> !<a href=""/>ByteString</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Done" class="def">Done</a> !<a href=""/>ByteString</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div><div class="top"><p class="src"><a name="v:toApplication" class="def">toApplication</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:RoutingApplication">RoutingApplication</a> -&gt; Application</p></div><div class="top"><p class="src"><span class="keyword">data</span> <a name="t:Delayed" class="def">Delayed</a> :: * -&gt; * <span class="keyword">where</span></p><div class="doc"><p>A <code><a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a></code> is a representation of a handler with scheduled
 delayed checks that can trigger errors.</p><p>Why would we want to delay checks?</p><p>There are two reasons:</p><ol><li>Currently, the order in which we perform checks coincides
 with the error we will generate. This is because during checks,
 once an error occurs, we do not perform any subsequent checks,
 but rather return this error.</li></ol><p>This is not a necessity: we could continue doing other checks,
 and choose the preferred error. However, that would in general
 mean more checking, which leads us to the other reason.</p><ol><li>We really want to avoid doing certain checks too early. For
 example, captures involve parsing, and are much more costly
 than static route matches. In particular, if several paths
 contain the &quot;same&quot; capture, we'd like as much as possible to
 avoid trying the same parse many times. Also tricky is the
 request body. Again, this involves parsing, but also, WAI makes
 obtaining the request body a side-effecting operation. We
 could/can work around this by manually caching the request body,
 but we'd rather keep the number of times we actually try to
 decode the request body to an absolute minimum.</li></ol><p>We prefer to have the following relative priorities of error
 codes:</p><pre>404
405 (bad method)
401 (unauthorized)
415 (unsupported media type)
400 (bad request)
406 (not acceptable)
</pre><p>Therefore, while routing, we delay most checks so that they
 will ultimately occur in the right order.</p><p>A <code><a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a></code> contains three delayed blocks of tests, and
 the actual handler:</p><ol><li>Delayed captures. These can actually cause 404, and
 while they're costly, they should be done first among the
 delayed checks (at least as long as we do not decouple the
 check order from the error reporting, see above). Delayed
 captures can provide inputs to the actual handler.</li><li>Method check(s). This can cause a 405. On success,
 it does not provide an input for the handler. Method checks
 are comparatively cheap.</li><li>Body and accept header checks. The request body check can
 cause both 400 and 415. This provides an input to the handler.
 The accept header check can be performed as the final
 computation in this block. It can cause a 406.</li></ol></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Delayed" class="def">Delayed</a> ::  <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> ()) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> b) -&gt; (a -&gt; b -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> c) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> c</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="subs instances"><p id="control.i:Delayed" class="caption collapser" onclick="toggleSection('i:Delayed')">Instances</p><div id="section.i:Delayed" class="show"><table><tr><td class="src clearfix"><span class="inst-left"><a href=""/>Functor</a> <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a></span></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><a name="v:addCapture" class="def">addCapture</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> (a -&gt; b) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> b</p><div class="doc"><p>Add a capture to the end of the capture block.</p></div></div><div class="top"><p class="src"><a name="v:addMethodCheck" class="def">addMethodCheck</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> ()) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a</p><div class="doc"><p>Add a method check to the end of the method block.</p></div></div><div class="top"><p class="src"><a name="v:addBodyCheck" class="def">addBodyCheck</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> (a -&gt; b) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> b</p><div class="doc"><p>Add a body check to the end of the body block.</p></div></div><div class="top"><p class="src"><a name="v:addAcceptCheck" class="def">addAcceptCheck</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> ()) -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a</p><div class="doc"><p>Add an accept header check to the end of the body block.
 The accept header check should occur after the body check,
 but this will be the case, because the accept header check
 is only scheduled by the method combinators.</p></div></div><div class="top"><p class="src"><a name="v:passToServer" class="def">passToServer</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> (a -&gt; b) -&gt; a -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> b</p><div class="doc"><p>Many combinators extract information that is passed to
 the handler without the possibility of failure. In such a
 case, <code><a href="Servant-Server-Internal-RoutingApplication.html#v:passToServer">passToServer</a></code> can be used.</p></div></div><div class="top"><p class="src"><a name="v:bindRouteResults" class="def">bindRouteResults</a> :: <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; (a -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> b)) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> b)</p><div class="doc"><p>The combination 'IO . RouteResult' is a monad, but we
 don't explicitly wrap it in a newtype in order to make it
 an instance. This is the <code><a href=""/>&gt;&gt;=</a></code> of that monad.</p><p>We stop on the first error.</p></div></div><div class="top"><p class="src"><a name="v:combineRouteResults" class="def">combineRouteResults</a> :: (a -&gt; b -&gt; c) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> b) -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> c)</p><div class="doc"><p>Common special case of <code><a href="Servant-Server-Internal-RoutingApplication.html#v:bindRouteResults">bindRouteResults</a></code>, corresponding
 to <code>liftM2</code>.</p></div></div><div class="top"><p class="src"><a name="v:runDelayed" class="def">runDelayed</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> a -&gt; <a href=""/>IO</a> (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> a)</p><div class="doc"><p>Run a delayed server. Performs all scheduled operations
 in order, and passes the results from the capture and body
 blocks on to the actual handler.</p></div></div><div class="top"><p class="src"><a name="v:runAction" class="def">runAction</a> :: <a href="Servant-Server-Internal-RoutingApplication.html#t:Delayed">Delayed</a> (<a href=""/>ExceptT</a> <a href="Servant-Server-Internal-ServantErr.html#t:ServantErr">ServantErr</a> <a href=""/>IO</a> a) -&gt; (<a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> Response -&gt; <a href=""/>IO</a> r) -&gt; (a -&gt; <a href="Servant-Server-Internal-RoutingApplication.html#t:RouteResult">RouteResult</a> Response) -&gt; <a href=""/>IO</a> r</p><div class="doc"><p>Runs a delayed server and the resulting action.
 Takes a continuation that lets us send a response.
 Also takes a continuation for how to turn the
 result of the delayed server into a response.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.16.1</p></div></body></html>